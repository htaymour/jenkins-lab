#!groovy

// ============== NOTES =============
// curl -o $WORKSPACE/ccr1 -L 'https://github.com/htaymour/jenkins-lab/blob/main/ccr/ccr1'
  /* scm{
    description("Pull files from github repo when some developers push code to github")

    git 'https://github.com/htaymour/jenkins-lab.git' --origin maain

  } */
//   steps { 
//     script {
   
//     mail to: 'haytham.taymour@orange.com',
//     subject: "Job '${JOB_NAME}' (${BUILD_NUMBER}) is waiting for input",
//     body: "Please go to ${BUILD_URL} and verify the build"  
// }}



pipeline {
    agent none
    stages {
        stage('Init') {
            agent any
            options {
                // Timeout counter starts BEFORE agent is allocated
                timeout(time: 100, unit: 'SECONDS')
            }
            steps {
                  echo ' ** Init statge steps !'
                  sh '''
                  cd 
                  pwd
                  echo 'CCR request downloaded. Showing contents of latest file :'
                  cat "$(ls ccr/ -r  | grep ccr | head -n1)"
                  '''
                  //cat "$(ls -tp | grep -v / | head -n1)"
                  // pwd
                  


            script {
                  def ccr_file=sh(script: "ls ccr/ -tp | grep -v / | head -n1", returnStdout: true).replaceAll("[\\n\\r]", "")
                  echo "The captured file is: ${ccr_file} and the rest of files${ccr_file} like this"
                  sh (script:"cp ccr/${ccr_file} cac/.")
                //   sh (script: "docker build /var/lib/jenkins/workspace/ci-monitoring/cac/.  -t deployer ", returnStdout: true)
                  sh ("docker run --rm deployer python start_pipe.py ${ccr_file} ") 
                  //sh ("docker run deployer ls ") 

            }
                
                

            }
        }
    }
}