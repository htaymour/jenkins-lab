#!groovy

// ============== NOTES =============
// curl -o $WORKSPACE/ccr1 -L 'https://github.com/htaymour/jenkins-lab/blob/main/ccr/ccr1'
  /* scm{
    description("Pull files from github repo when some developers push code to github")

    git 'https://github.com/htaymour/jenkins-lab.git' --origin maain

  } */
//   steps { 
//     script {
   
//     mail to: 'haytham.taymour@orange.com',
//     subject: "Job '${JOB_NAME}' (${BUILD_NUMBER}) is waiting for input",
//     body: "Please go to ${BUILD_URL} and verify the build"  
// }}



pipeline {
    agent none
    //  environment {
    //     GIT_CREDENTIALS_ID = 'git-credentials' // The ID you gave your credentials
    //     GIT_USER_EMAIL = 'user@example.com' // The user's email to configure in Git
    //     GIT_USER_NAME = 'Your Name' // The user's name to configure in Git
    // }
    stages {
        stage('Init') {
            agent any
            options {
                // Timeout counter starts BEFORE agent is allocated
                timeout(time: 100, unit: 'SECONDS')
            }
            steps {
                  echo ' ** Init statge steps !'
                  sh '''
                  pwd
                  echo 'CCR request downloaded. Showing contents of latest file :'
                  cat ccr/"$(ls ccr/ -r  | grep ccr | head -n1)"
                  '''
                  //cat ccr/"$(ls ccr/ -r  | grep ccr | head -n1)"
                  // pwd
                  


            script {
              
                  def ccr_file=sh(script: "ls ccr/ -r  | grep ccr | head -n1", returnStdout: true).replaceAll("[\\n\\r]", "")
                  echo "The captured file is: ${ccr_file}        * Sent from Jenkins "
                  // sh (script:"cp ccr/${ccr_file} cac/.")
                //   sh (script: "docker build /var/lib/jenkins/workspace/ci-monitoring/cac/.  -t deployer ", returnStdout: true)
                def container=sh(script: "docker ps -aq", returnStdout: true).replaceAll("[\\n\\r]", "").replaceAll(" ", "")
                  if (container == '') {
                        echo 'No old Container exist'
                    } else {
                        echo "The old container name is ${container}"
                        sh ("docker rm -f ${container}")
                    }
                  sh ("git checkout main")                               // needed before modifying the file to push back via plugin
                  sh ("docker run -d --name deployer2 deployer tail -f /dev/null")                      // Start the container 
                  sh ("docker cp /var/lib/jenkins/workspace/ci-monitoring/cac/. deployer2:/usr/src/ ")  // only used when skip build
                  sh ("docker cp /var/lib/jenkins/workspace/ci-monitoring/ccr/${ccr_file} deployer2:/usr/src/ ")
                  sh ("docker exec deployer2 python /usr/src/start_pipe.py ${ccr_file} ")               // Deploy the job on container
                  sh ("docker cp deployer2:/usr/src/logs/. /var/lib/jenkins/workspace/ci-monitoring/logs/")  //getting logs from finished job
                  sh ("docker rm -f deployer2")                                                       // cleaning up
                  // sh ("rm ${ccr_file}")
                  // updating repo
                  sh ("git config user.email htaymour@github.com")
                  sh ("git add .")
                  sh ("git commit -am 'Jenkis auto-commit by change file ${ccr_file} for build number $BUILD_NUMBER'")
                  sh ("git push -u origin main") 
            //       catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
            //       withCredentials([usernamePassword(credentialsId: 'example-secure', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
            // def encodedPassword = URLEncoder.encode("$GIT_PASSWORD",'UTF-8')
            // sh "git config user.email admin@example.com"
            // sh "git config user.name example"
            // sh "git add ."
            // sh "git commit -m 'Triggered Build: ${env.BUILD_NUMBER}'"
            // sh "git push https://${GIT_USERNAME}:${encodedPassword}@github.com/${GIT_USERNAME}/example.git"
       // }






  // //                 withCredentials([sshUserPrivateKey(credentialsId: '<credential-id>', keyFileVariable: 'SSH_KEY')]) {
  // //  sh("git push origin --all")
  //  withCredentials([usernamePassword(credentialsId: 'htaymour',
  //                usernameVariable: 'htaymour',
  //                passwordVariable: '')]){
  //   sh("git push http://$username:$password@https://github.com/htaymour/jenkins-lab")
  //                }
                  
           

            }
            }
        }
    }
}